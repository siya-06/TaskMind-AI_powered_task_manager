<!DOCTYPE html> 
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI powered task-manager| Node.JS Express.JS Postgresql</title>
    <link rel="stylesheet" href="/style.css" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
  <!-- AUTH SECTION -->
  <section id="auth" class="auth-card">
    <div class="auth-header">
      <h2 class="sign-up-text">Login</h2>
    </div>

    <p id="error" style="display: none;"></p>
    <input id="emailInput" placeholder="Email" />
    <input id="passwordInput" placeholder="********" type="password" />

    <button id="authBtn" class="btn-primary" onclick="authenticate()">
      <i class="fa-solid fa-right-to-bracket"></i> Submit
    </button>

    <hr />

    <div class="register-content">
      <p>Don't have an account?</p>
      <button onclick="toggleIsRegister()" id="registerBtn" class="btn-secondary">
        <i class="fa-solid fa-user-plus"></i> Sign up
      </button>
    </div>
  </section>

  <!-- HEADER -->
  <header style="display: none;">
    <h1 class="text-gradient">You have 0 open tasks.</h1>
  </header>

  <!-- NAVIGATION -->
  <nav style="display: none;" class="tab-container">
    <div class="nav-left">
      <button onclick="changeTab('All')" class="tab-button selected-tab">
        <i class="fa-solid fa-list"></i>
        <h4>All <span>(0)</span></h4>
      </button>
      <button onclick="changeTab('Open')" class="tab-button">
        <i class="fa-regular fa-square"></i>
        <h4>Open <span>(0)</span></h4>
      </button>
      <button onclick="changeTab('Complete')" class="tab-button">
        <i class="fa-solid fa-check"></i>
        <h4>Complete <span>(0)</span></h4>
      </button>
    </div>
    <br>
    <div class="nav-right">
      <button onclick="logout()" class="btn-logout">
        <i class="fa-solid fa-arrow-right-from-bracket"></i> Logout
      </button>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main style="display: none;"></main>
</body>



<script>
    let token = localStorage.getItem('token')

    let isLoading = false
    let isAuthenticating = false
    let isRegistration = false
    let selectedTab = 'All'
    let todos = []

    const apiBase = '/'

    // elements
    const nav = document.querySelector('nav')
    const header = document.querySelector('header')
    const main = document.querySelector('main')
    const navElements = document.querySelectorAll('.tab-button')
    const authContent = document.getElementById('auth')
    const error = document.getElementById('error')
    const email = document.getElementById('emailInput')
    const password = document.getElementById('passwordInput')
    const registerBtn = document.getElementById('registerBtn')
    const authBtn = document.getElementById('authBtn')

    // PAGE RENDERING LOGIC
    async function showDashboard() {
        nav.style.display = 'block'
        header.style.display = 'flex'
        main.style.display = 'flex'
        authContent.style.display = 'none'
        await fetchTodos()
    }

    function updateHeaderText() {
        const todosLength = todos.length
        const newString = todosLength === 1 ?
            `You have 1 open task.` :
            `You have ${todosLength} open tasks.`
        header.querySelector('h1').innerText = newString
    }

    function updateNavCount() {
        navElements.forEach(ele => {
            const btnText = ele.innerText.split(' ')[0]
            const count = todos.filter(val => {
                if (btnText === 'All') return true
                return btnText === 'Complete' ? val.completed : !val.completed
            }).length
            ele.querySelector('span').innerText = `(${count})`
        })
    }
    function logout() {
    // clear token
    localStorage.removeItem('token')
    token = null

    // reset UI
    nav.style.display = 'none'
    header.style.display = 'none'
    main.style.display = 'none'
    authContent.style.display = 'flex'
    }

    function changeTab(tab) {
        selectedTab = tab
        navElements.forEach(val => {
            if (val.innerText.includes(tab)) {
                val.classList.add('selected-tab')
            } else {
                val.classList.remove('selected-tab')
            }
        })
        renderTodos()
    }

    function renderTodos() {
        
        updateNavCount()
        updateHeaderText()

        let todoList = ``
        todos.filter(val => {
            return selectedTab === 'All' ? true :
                selectedTab === 'Complete' ? val.completed : !val.completed
        }).forEach(todo => {
            const taskIndex = todo.id
            todoList += `
            <div class="card todo-item">
                <p>${todo.task}</p>
                <div class="todo-buttons">
                    <button onclick="updateTodo(${taskIndex})" ${todo.completed ? 'disabled' : ''}>
                        <h6>Done</h6>
                    </button>
                    <button onclick="deleteTodo(${taskIndex})">
                        <h6>Delete</h6>
                    </button>
                    <button onclick="categorizeTodoExisting(${taskIndex})">
                    
                        <h6>Categorize</h6>
                    </button>
                </div>
            </div>`
        })

        todoList += `
        <div class="input-container">
            <input id="todoInput" placeholder="Add task" />
            <button onclick="addTodo()">
                <i class="fa-solid fa-plus"></i>
            </button>
            <button onclick="categorizeTodo()">Categorize</button>
        </div>`

        todoList += `
        <div class="suggest-container">
            <button onclick="getAiSuggestions()"> Suggest Tasks</button>
        </div>`

        main.innerHTML = todoList
    }
    async function categorizeTodoExisting(id) {
    const todo = todos.find(t => t.id === id) // find todo by id
    if (!todo) return

    const res = await fetch(apiBase + "todos/ai/categorize", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": token
        },
        body: JSON.stringify({ task: todo.task })
    })

    const data = await res.json()
    alert(`AI suggests this task is: ${data.tag}`)
}


    // AI FUNCTIONS
    async function getAiSuggestions() {
        const res = await fetch(apiBase + "todos/ai/suggest", {
            headers: { "Authorization": token }
        })
        const data = await res.json()
        const suggestions = data.tasks

        suggestions.forEach(async (task) => {
            await fetch(apiBase + "todos", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": token
                },
                body: JSON.stringify({ task })
            })
        })
        fetchTodos()
    }
    

    async function categorizeTodo() {
        const todoInput = document.getElementById("todoInput")
        const task = todoInput.value
        if (!task) return

        const res = await fetch(apiBase + "todos/ai/categorize", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": token
            },
            body: JSON.stringify({ task })
        })

        const data = await res.json()
        alert(`AI suggests this task is: ${data.tag}`)
    }

    // AUTH LOGIC
    async function toggleIsRegister() {
        isRegistration = !isRegistration
        registerBtn.innerText = isRegistration ? 'Sign in' : 'Sign up'
        document.querySelector('#auth > div h2').innerText = isRegistration ? 'Sign Up' : 'Login'
        document.querySelector('.register-content p').innerText = isRegistration ? 'Already have an account?' : 'Don\'t have an account?'
        document.querySelector('.register-content button').innerText = isRegistration ? ' Login' : 'Sign up'
    }

    async function authenticate() {
        const emailVal = email.value
        const passVal = password.value

        if (
            isLoading ||
            isAuthenticating ||
            !emailVal ||
            !passVal ||
            passVal.length < 6 ||
            !emailVal.includes('@')
        ) { return }

        error.style.display = 'none'
        isAuthenticating = true
        authBtn.innerText = 'Authenticating...'

        try {
            let response, data;
            if (isRegistration) {
                response = await fetch(apiBase + 'auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: emailVal, password: passVal })
                })
                data = await response.json()
            } else {
                response = await fetch(apiBase + 'auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: emailVal, password: passVal })
                })
                data = await response.json()
            }

            if (data.token) {
                token = data.token
                localStorage.setItem('token', token)
                authBtn.innerText = 'Loading...'
                await fetchTodos()
                showDashboard()
            } else {
                if (isRegistration) {
                    throw Error(data.error || "❌ Failed to register. Maybe username already exists?")
                } else {
                    throw Error('❌ Failed to login. Check your credentials.')
                }
            }
        } catch (err) {
            console.log(err.message)
            error.innerText = err.message
            error.style.display = 'block'
        } finally {
            authBtn.innerText = 'Submit'
            isAuthenticating = false
        }
    }

    // CRUD LOGIC
    async function fetchTodos() {
        isLoading = true
        const response = await fetch(apiBase + 'todos', {
            headers: { 'Authorization': token }
        })
        const todosData = await response.json()
        todos = todosData
        isLoading = false
        renderTodos()
    }

    async function updateTodo(index) {
        await fetch(apiBase + 'todos/' + index, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },
            body: JSON.stringify({ completed: 1 })
        })
        fetchTodos()
    }

    async function deleteTodo(index) {
        await fetch(apiBase + 'todos/' + index, {
            method: 'DELETE',
            headers: { 'Authorization': token }
        })
        fetchTodos()
    }

    async function addTodo() {
        const todoInput = document.getElementById('todoInput')
        const task = todoInput.value
        if (!task) return

        await fetch(apiBase + 'todos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },
            body: JSON.stringify({ task })
        })
        todoInput.value = ''
        fetchTodos()
    }
    




    // AUTO LOGIN IF TOKEN EXISTS
    if (token) {
        async function run() {
            await fetchTodos()
            showDashboard()
        }
        run()
    }
</script>

</html>
